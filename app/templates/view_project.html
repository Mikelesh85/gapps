{% extends "layouts/sidebar-nav.html" %}

{% import "helpers/snippets.html" as snippet with context %}
{% block before_head %}
  {{ super() }}
  {% import "helpers/src_macros.html" as macro %}
  {{ macro.filehelper(datatables=True,select2=True,apex=True,editor=True,mentions=True,utils=True) }}
  <style>
    .breadcrumbs>ul>li+:before {
      margin-top: 5px;
    }
  </style>
{% endblock %}

{%block header%}{%endblock%}
{%block page_header%}{%endblock%}

{%block tenant_btn%}{%endblock%}
{%set is_auditor = project.has_auditor(current_user)%}
{%block content%}
<div class="grid grid-cols-9 gap-8">
  <div class="col-span-9">
<div class="lg:flex lg:items-center lg:justify-between">
  <div class="min-w-0 flex-1">
    <div class="breadcrumbs text-2xl font-bold sm:tracking-tight py-0">
      <ul>
        <li><a>Home</a></li>
        <li><a href="{{url_for("main.projects")}}">Projects</a></li>
        <li><a class="capitalize" href="{{url_for("main.view_project",pid=project.id)}}">{{project.name}}</a></li>
        <li>
          <select class="select text-2xl font-bold text-primary sm:tracking-tight pl-0 focus:border-transparent focus:outline-none tab-select hover:text-secondary">
            <option selected value="summary">Summary</option>
            <option value="controls">Controls</option>
            <option value="policies">Policies</option>
            <option value="evidence">Evidence</option>
            <option value="matrix">Resp. Matrix</option>
            <option value="scratchpad">Scratchpad</option>
            <option value="comments">Comments</option>
            <option value="report">Report</option>
            <option value="settings">Settings</option>
          </select>
        </li>
      </ul>
    </div>

  </div>
  <div class="flex">
    <span class="ml-3 hidden sm:block">
      <div class="tooltip tooltip-left" data-tip="Generate PDF report"><button class="btn btn-ghost border border-base-300 btn-sm" @click="createReport">Generate Report</button></div>
    </span>
    <span class="ml-3 hidden sm:block">
      <div class="tooltip tooltip-left" data-tip="Refresh data from Server"><button class="format-btn btn btn-sm btn-primary reload-button">Refresh Data</button></div>
    </span>
  </div>
</div>
    <div class="flex flex-row py-3">
      <div class="flex gap-x-1 py-1 pr-2 tooltip" data-tip="Framework">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>
        <span class="text-sm font-medium uppercase">{{project.framework.name}}</span>
      </div>
      <div class="flex gap-x-1 py-1 px-2 tooltip" data-tip="Completion">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
        <span class="text-sm font-medium">{{project.progress("complete")}}%</span>
      </div>
      <div class="flex gap-x-1 py-1 px-2 tooltip" data-tip="Start Date">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z" /></svg>
        <span class="text-sm font-medium">{{project.simple(project.date_added)}}</span>
      </div>
      {%if is_auditor%}
      <div class="flex gap-x-1 py-1 px-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
        <span class="text-sm font-medium">Auditor</span>
      </div>
      {%endif%}
      <div class="divider divider-horizontal mx-0"></div>
      <div class="flex space-x-4 tabs">
        {%for tab in ["summary","controls","policies","evidence","matrix","scratchpad","comments","report","settings"]%}
        <span @click="changeTab('{{tab}}')" id="tab-{{tab}}" class="cursor-pointer rounded-md py-1 px-4 text-sm font-medium hover:bg-base-200 capitalize">{{tab}}</span>
        {%endfor%}
      </div>
    </div>
    <div class="flex flex-row rounded-md border border-base-300 p-3">
      <div class="flex gap-x-1 py-1 tooltip font-medium text-sm" data-tip="Quick filters for the controls">Quick Filters</div>
      <div class="divider divider-horizontal mx-0"></div>
      <div id="quick-filters" class="flex gap-x-4 tabs"></div>
    </div>

  </div>
  </div>
  <div id="page-div">
    <div class="grid grid-cols-9 gap-4" id="alert-div"></div>
    <div class="grid grid-cols-9 gap-4" id="summary-div"></div>
    <div class="grid grid-cols-9 gap-4 mt-4 pb-10" id="card-div">
      <div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>
    </div>
  </div>
</div>

<input type="checkbox" id="memberModal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box w-8/12 max-w-4xl">
    <label for="memberModal" class="btn btn-sm btn-circle absolute right-2 top-2">✕</label>
    <div id="memberModalBody">
      <div class="grid grid-cols-6 gap-6"><div class="col-span-6"><label class="block font-medium mb-2">Add Members to Project</label><select class="input-members w-full" name="members[]" multiple="multiple"/></select></div></div>
    </div>
    <div class="modal-action">
      <button @click="addMembers" class="btn btn-primary add-project-member-btn">Save</button>
    </div>
  </div>
</div>

<input type="checkbox" id="ownerModal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <label for="ownerModal" class="btn btn-sm btn-circle absolute right-2 top-2">✕</label>
    <div id="ownerModalBody"></div>
    <div class="modal-action">
      <button data-id="" class="btn btn-primary save-owner-btn">Save</button>
    </div>
  </div>
</div>

<input type="checkbox" id="control-modal" class="modal-toggle" />
<label for="control-modal" class="modal cursor-pointer">
  <label class="modal-box relative w-11/12 max-w-5xl" for="">
    <div class="flex justify-between">
      <div>
        <h2 id="control-modal-title" class="card-title mb-2 capitalize"></h2>
      </div>
      <div>
        <span id="control-modal-date" class="text-xs">?</span>
      </div>
    </div>
    <div class="grid grid-cols-6 gap-4">
      <div class="col-span-6" id="applicable-control"></div>
      <div class="col-span-3">
        <div class="card border border-base-300">
          <div class="card-body p-5">
            <div class="card-title justify-between">
              <h2 class="card-title text-lg">Complete</h2>
              <div id="complete-modal-icon"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-span-3">
        <div class="card border border-base-300">
          <div class="card-body p-5">
            <div class="card-title justify-between">
              <h2 class="card-title text-lg">Applicable</h2>
              <div id="applicable-modal-icon"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-span-4">
        <div class="overflow-hidden shadow sm:rounded-lg"><div class="px-4 py-5 sm:px-6"><h3 class="text-lg font-medium leading-6">Control Details</h3></div><div class="border-t border-base-300"><dl id="control-modal-details"></dl></div></div>
      </div>
      <div class="col-span-2 m-auto flex flex-col">
        <div class="mx-auto" id="control-modal-completion"></div>
        <div class="mx-auto mt-2 text-sm font-semibold">Progress of control</div>
      </div>
    </div>
    <div class="modal-action">
      <a id="view-control" href="" class="btn btn-primary">View</a>
    </div>
  </label>
</label>

<input type="checkbox" id="policy-modal" class="modal-toggle" />
<label for="policy-modal" class="modal cursor-pointer">
  <label class="modal-box relative w-11/12 max-w-5xl" for="">
    <div class="flex justify-between">
      <div>
        <p class="font-semibold text-primary text-sm" id="policy-subtitle"></p>
        <h2 class="card-title mb-5">Policy</h2>
      </div>
      <div>
        <span class="text-xs" id="policy-date"></span>
      </div>
    </div>
    <div class="grid grid-cols-6 gap-6">
      <div class="col-span-6 sm:col-span-3">
        <label class="block text-sm font-medium  mb-2">Name</label>
        <span id="tenant-select-div" class=""></span>
      </div>
      <div class="col-span-6 sm:col-span-3">
        <label class="block text-sm font-medium  mb-2"></label>
        <span id="framework-select-div" class=""></span>
      </div>
    </div>
    <div class="modal-action">
      <a id="view-policy" href="#" class="btn btn-primary">View</a>
    </div>
  </label>
</label>

<input type="checkbox" id="owner-modal" class="modal-toggle" />
<label for="owner-modal" class="modal cursor-pointer">
  <label class="modal-box relative w-11/12 max-w-5xl" for="">
    <div class="flex justify-between">
      <div>
        <p class="font-semibold text-primary text-sm"></p>
        <h2 id="owner-modal-title" class="card-title mb-5">Owner</h2>
      </div>
    </div>
    <div class="grid grid-cols-6 gap-6">
      <div class="col-span-6">
        <div class="">
          <table class="table w-full">
            <!-- head -->
            <thead>
              <tr>
                <th class="w-1"></th>
                <th>Name</th>
                <th class="w-1">View</th>
              </tr>
            </thead>
            <tbody id="owner-modal-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </label>
</label>
<input type="checkbox" id="operator-modal" class="modal-toggle" />
<label for="operator-modal" class="modal cursor-pointer">
  <label class="modal-box relative w-11/12 max-w-5xl" for="">
    <div class="flex justify-between">
      <div>
        <p class="font-semibold text-primary text-sm"></p>
        <h2 id="operator-modal-title" class="card-title mb-5">Operator</h2>
      </div>
    </div>
    <div class="grid grid-cols-6 gap-6">
      <div class="col-span-6">
        <div class="">
          <table class="table w-full">
            <!-- head -->
            <thead>
              <tr>
                <th class="w-1"></th>
                <th>Name</th>
                <th class="w-1">View</th>
              </tr>
            </thead>
            <tbody id="operator-modal-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </label>
</label>
{%endblock%}
{%block extrajs%}
<script>

  /** Region: Data */

  const projectTabs = {
    SUMMARY: "summary",
    CONTROLS: "controls",
    POLICIES: "policies",
    EVIDENCE: "evidence",
    RESPONSIBILITY_MATRIX: "matrix",
    SCRATCHPAD: "scratchpad",
    COMMENT: "comment",
    REPORT: "report",
    SETTINGS: "settings",
  }

  const controlsGrouping = {
    CONTROLS: "controls",
    SUBCONTROLS: "subcontrols"
  };

  const controlSelectOptions = {
    all: 'All',
    has_evidence: "Has Evidence",
    missing_evidence: "Missing Evidence",
    implemented: "Implemented",
    not_implemented: "Not Implemented",
    is_applicable: "Is applicable",
    not_applicable: "Not applicable",
    complete: 'Complete',
    not_complete: 'Not Complete'
  };

  const subControlSelectOptions = {
    all: 'All',
    am_owner: "Controls I own",
    am_operator: "Controls I operate",
    is_applicable: "Is applicable",
    not_applicable: "Not applicable",
    has_evidence: "Has Evidence",
    missing_evidence: "Missing Evidence",
    complete: 'Complete',
    not_complete: 'Not Complete',
    implemented: "Implemented",
    not_implemented: "Not Implemented",
    review_not_started: "Review: Not Started",
    review_infosec_action: "Review: InfoSec Action",
    review_action_required: "Review: Action Required",
    review_ready_for_auditor: "Review: Ready for Auditor",
    review_complete: "Review: Complete"
  };

  const quickFiltersData = {
    am_owner: "Controls I own",
    am_operator: "Controls I operate",
    review_not_started: "Not started",
    not_implemented: "In progress",
    review_action_required: "Action Required",
    review_ready_for_auditor: "Ready for Auditor",
    complete: 'Complete'
  }

  /** End Region: Data */

  /** Region: HTML Fragments */

  const iconCheckmark = (`
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="mx-auto w-5 h-5 text-green-600">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
    </svg>
  `);

  const iconNegative = (`
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="mx-auto w-5 h-5 text-red-600">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
  `);

  const iconNotApplicable = (`
    <div class="tooltip" data-tip="Not Applicable">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="mx-auto w-5 h-5 text-gray-600">
        <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
      </svg>
    </div>`
  );

  const iconNoAvatar = (`
    <div class="avatar placeholder font-semibold">
      <div class="text-gray-600 bg-gray-400/20 rounded-full w-8">
        <span class="text-xs capitalize">?</span>
      </div>
    </div>
  `);

  const iconAvatar = (userEmail) => (`
    <div class="avatar placeholder font-semibold">
      <div class="text-green-600 bg-green-400/20 rounded-full w-8">
        <span class="text-xs capitalize">${userEmail[0]}</span>
      </div>
    </div>
  `);

  const cardBlock = (`
    <div class="col-span-9 mx-auto mt-10">
      <div class="justify-center flex" role="status">
        <svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
          <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
        </svg>
        <span class="sr-only">Loading...</span>
      </div>
    </div>
  `);

  /** Endregion: HTML Fragments */

  /** Region: Helper methods */

  const changeTab = (tab) => {
    $(".tabs span").removeClass("bg-base-200");
    $(`#tab-${tab}`).addClass("bg-base-200");
    resetUrlQueryString(tab);
    loadPageElements(tab);
    updateActiveQuickFilter();
  }

  const loadQuickFilters = () => {
    const projectId = "{{project.id}}";
    const baseUrl = `/projects/${projectId}?tab=controls&grouping=subcontrols`;
    const $quickFilterButtonContainer = $("#quick-filters");
    $quickFilterButtonContainer.empty();

    for (const [key, value] of Object.entries(quickFiltersData)) {
      const $button = $("<a>", {
        id: `qf-${key}`,
        text: value,
        class: `btn btn-xs btn-ghost border border-base-300`,
        href: `${baseUrl}&filter=${key}`
      });
      $quickFilterButtonContainer.append($button);
    }
    updateActiveQuickFilter();
  }

  const updateActiveQuickFilter = () => {
    const params = new window.URLSearchParams(window.location.search);
    const tab = params.get("tab");
    const grouping = params.get("grouping");
    const filter = params.get("filter");

    $("#quick-filters a").each(function() {
      $(this).removeClass("btn-primary").addClass("btn-ghost");
    });

    if (tab === projectTabs.CONTROLS && grouping === controlsGrouping.SUBCONTROLS && filter) {
      const $quickFilterLink = $(`#qf-${filter}`);
      if ($quickFilterLink) {
        $quickFilterLink.removeClass("btn-ghost").addClass("btn-primary");
      }
    }
  };

  const resetUrlQueryString = (tab) => {
    const noQueryUrl = window.location.origin + window.location.pathname;
    const baseUrl = `${noQueryUrl}?tab=${tab}`;
    window.history.replaceState({}, document.title, noQueryUrl);
  };

  const setUrlParams = (params) => {
    const baseUrl = window.location.origin + window.location.pathname;
    const newUrl = baseUrl + '?' + params.toString();
    window.history.replaceState({}, document.title, newUrl);
  };

  const setDefaultGrouping = () => {
    const params = new window.URLSearchParams(window.location.search);
    const tab = params.get("tab");
    const grouping = params.get("grouping");
    const filter = params.get("filter");
    
    if (!tab) {
      params.set("tab", controlsGrouping.CONTROLS);
    }
    if (!grouping) {
      params.set("grouping", controlsGrouping.CONTROLS);
    }
    if (!filter) {
      params.set("filter", "all");
    }
    setUrlParams(params);
  };

  const getControlStatusColor = (status) => {
    const statusColors = {
      "default": "gray",
      "complete": "green",
      "in progress": "yellow",
      "not applicable": "red",
    };
    if (statusColors.hasOwnProperty(status)) {
      return statusColors[status];
    }
    return statusColors["default"];
  };

  const getSubControlStatusColor = (status) => {
    const statusColors = {
      "default": "gray",
      "complete": "green",
      "action required": "red",
      "infosec action": "yellow",
      "ready for auditor": "blue"
    };
    if (statusColors.hasOwnProperty(status)) {
      return statusColors[status];
    }
    return statusColors["default"];
  };

  const getControlsFilterSelectOptions = () => {
    const params = new window.URLSearchParams(window.location.search);
    const grouping = params.get("grouping");
    const listToUse = grouping && grouping === controlsGrouping.SUBCONTROLS ? subControlSelectOptions : controlSelectOptions;

    let options = "";
    for (const [key, value] of Object.entries(listToUse)) {
      options = options.concat(`<option value="${key}">${value}</option>`);
    }
    return options;
  };

  const getGroupingFilterSelectOptions = () => {
    const params = new window.URLSearchParams(window.location.search);
    const grouping = params.get("grouping");

    let options = "";
    for (const [key, value] of Object.entries(controlsGrouping)) {
      options = options.concat(`<option value="${value}">Grouping: ${value.charAt(0).toUpperCase() + value.slice(1)}</option>`);
    }
    return options;
  };

  /** End Region: Helper methods */

function loadUsers(reload=false) {
    var users = localStorage.getItem("tenant-users-{{project.tenant_id}}");
    if (reload || !users) {
      console.log("Pulling users from API")
      $.ajax({
        type: "GET",
        url: `/api/v1//tenants/{{project.tenant_id}}/users`,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
          localStorage.setItem('tenant-users-{{project.tenant_id}}', JSON.stringify(data));
        },
        error: function(errMsg) {
         toast(errMsg["responseJSON"]["message"],"error")
         return(errMsg);
        }
      })
    } 
}

  function populateOwnerModal(id, owner, operator){
    $("#ownerModalBody").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
    document.getElementById('ownerModal').checked = true;
    var users = JSON.parse(localStorage.getItem("tenant-users-{{project.tenant_id}}"));
    $(".save-owner-btn").data("id", id)
    ownerSelect = '<label class="block text-sm font-medium mb-2">Owner of the Control</label><select class="select select-md w-full max-w-xs select-bordered owner-id"><option value="empty">Select an Owner</option>'
    for(var user in users) {
      if (users[user].email === owner) {
        ownerSelect+=`<option value="${users[user].id}" selected>${users[user].email}</option>`
      } else {
        ownerSelect+=`<option value="${users[user].id}">${users[user].email}</option>`
      }
    }
    ownerSelect+='</select>'
    operatorSelect = '<label class="block text-sm font-medium mb-2 mt-5">Operator of the Control</label><select class="select select-md w-full max-w-xs select-bordered operator-id"><option value="empty">Select an Operator</option>'
    for(var user in users) {
      if (users[user].email === operator) {
        operatorSelect+=`<option value="${users[user].id}" selected>${users[user].email}</option>`
      } else {
        operatorSelect+=`<option value="${users[user].id}">${users[user].email}</option>`
      }
    }
    operatorSelect+='</select>'
    $("#ownerModalBody").html(ownerSelect);
    $("#ownerModalBody").append(operatorSelect);
  }
function saveScratchPad(showToast=true) {
    var data = {"data":tinymce.get("scratchpad-editor").getContent()}
    $.ajax({
        type: "PUT",
        url: `/api/v1/projects/{{project.id}}/scratchpad`,
        data: JSON.stringify(data),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
            $("#save-notes-btn").html("Save")
            $("#save-notes-btn").removeClass("btn-warning")
            $("#save-notes-btn").addClass("btn-primary")
            return(data)
        },
        error: function(errMsg) {
            // we autosave when a user clicks away but some users
            // dont have access to save, so we hide the error
            if (showToast) {
              toast(errMsg["responseJSON"]["message"],"error")
            }
            return(errMsg);
        }
    })
}
function createReport() {
    toast("Working on it...", "warning")
    $.ajax({
          type: "POST",
          url: `/api/v1/projects/{{project.id}}/reports`,
          contentType: "application/json; charset=utf-8",
          success: function(data){
            toast("Generated report")
            window.open(`/projects/{{project.id}}/reports/${data.name}`, '_blank').focus();
            return(data)
          },
          error: function(errMsg) {
            toast("Hmm.. we were unable to create a report","error")
            return(errMsg);
          }
    })
}

function blurOwnerFilter(e) {
  var owner = e.target.value;
  var operator = $('.operator-filter').val();
  var filter = $('.controls-filter').val();
  var grouping = $('.grouping-filter').val();
  var queryParams = new URLSearchParams(window.location.search);
  queryParams.set("filter", filter);
  queryParams.set("grouping", grouping);
  if (owner) {
    queryParams.set("owner", owner);
  } else {
    queryParams.delete("owner");
  }
  if (operator) {
    queryParams.set("operator", operator);
  } else {
    queryParams.delete("operator");
  }
  history.replaceState(null, null, "?"+queryParams.toString());
  if (grouping === "subcontrols") {
    loadControls()
  } else {
    loadControls(reload=true)
  }
}

function blurOperatorFilter(e) {
  const operator = e.target.value;
  const owner = $('.owner-filter').val();
  const filter = $('.controls-filter').val();
  const grouping = $('.grouping-filter').val();

  const params = new URLSearchParams(window.location.search);
  params.set("filter", filter);
  params.set("grouping", grouping);
  params.delete("owner");
  params.delete("operator");

  if (owner) {
    params.set("owner", owner);
  }
  if (operator) {
    params.set("operator", operator);
  }

  setUrlParams(params);
  loadControls();
}

/** Region: Events */

  $(document).on("change", ".controls-filter", function() {
    const filter = $(this).val();
    const params = new URLSearchParams(window.location.search);
    params.set("filter", filter);
    setUrlParams(params);
    loadControls();
    updateActiveQuickFilter();
  });

  $(document).on("change", ".grouping-filter", function() {
    const grouping = $(this).val();
    if (!grouping) {
      setDefaultGrouping();
    } else {
      const params = new URLSearchParams(window.location.search);
      params.set("grouping", grouping);
      params.set("filter", "all")
      setUrlParams(params);
    }
    loadControls();
    updateActiveQuickFilter();
  });

  $(document).on("change", ".tab-select", function() {
    const tab = $(this).val();
    changeTab(tab);
  });

  $(document).on("click", ".reload-button", function() {
    const keys = Object.keys(localStorage);
    const projectId = "{{project.id}}";
    const tenantId = "{{project.tenant_id}}";

    keys.forEach((key) => {
      if (key.startsWith(`grc-project-${projectId}-control-`)) {
        localStorage.removeItem(key);
      }
    });

    localStorage.removeItem(`tenant-users-${tenantId}`)
    const tab = $(".tab-select").val();
    loadUsers(reload=true);
    loadPageElements(tab);
  });

  $(document).on("click", ".remove-control-filter", function() {
    const params = new URLSearchParams(window.location.search);
    params.set("filter", "all");
    params.delete("owner");
    params.delete("operator");
    setUrlParams(params);
    loadControls();
  });

/** Endregion: Events */

function toggleScratchPad(e=false) {
  if (!e || !e.target.checked) {
    $(".tox-editor-header").addClass("invisible")
    $(".tox-editor-header").addClass("!h-0")
    tinymce.activeEditor.mode.set("readonly");
  } else {
    $(".tox-editor-header").removeClass("invisible")
    $(".tox-editor-header").removeClass("!h-0")
    tinymce.activeEditor.mode.set("design");
  }
}

function loadScratchPad() {
    {%if is_auditor and not project.can_auditor_read_scratchpad%}
    toast("You lack permissions to view the scratchpad.","warning")
    $("#card-div").html('<div class="col-span-9 mx-auto mt-10 flex flex-row">Insufficient Permissions<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.182 16.318A4.486 4.486 0 0012.016 15a4.486 4.486 0 00-3.198 1.318M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" /></svg></div>')
    return
    {%endif%}
    $("#card-div").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
    $.ajax({
        type: "GET",
        url: "/api/v1/projects/{{project.id}}/scratchpad",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){

        $("#card-div").html(`<div class="col-span-9">
          <div class="mb-4 justify-between flex">
            <div>
              <h1 class="text-2xl font-bold">Scratchpad</h1>
              <p class="text-sm">Use this place to document any details about the project or general notes and updates. {%if project.can_auditor_read_scratchpad%}The auditor <b>can read</b> the scratchpad.{%else%} The auditor <b>can not read</b> the scratchpad.{%endif%}</p>
            </div>
            <div class="gap-x-2 flex flex-row">
              {%if not is_auditor or project.can_auditor_write_scratchpad%}<div class="mt-1"><input @change="toggleScratchPad" type="checkbox" class="toggle toggle-primary"/></div>{%endif%}
              <button id="save-notes-btn" @click="saveScratchPad" class="btn btn-primary btn-sm">Save</button>
            </div>
          </div>
          <div id="scratchpad-editor" class="w-full">${data["notes"] || ""}</div>
        </div>`);
          tinymce.remove('#scratchpad-editor');
          var contextEditor = tinymce.init({
            //skin: 'snow',
            //icons: 'thin',
            //content_style: 'body { margin: 2rem 10%; }',
            setup: (editor) => {
              editor.on('init', (e) => {
                $(".tox-editor-header").addClass("invisible")
                $(".tox-editor-header").addClass("!h-0")
              });
              editor.on('keyup', (e) => {
                $("#save-notes-btn").html("Please Save")
                $("#save-notes-btn").removeClass("btn-primary")
                $("#save-notes-btn").addClass("btn-warning")
              });
            },
            selector: '#scratchpad-editor',
            statusbar: false,
            promotion: false,
            readonly: true,
            {%if is_auditor and not project.can_auditor_write_scratchpad%}
            menubar: false,
            toolbar: false,
            {%else%}
            plugins: "preview fullscreen searchreplace table codesample lists advlist variable link",
            toolbar1: "bold italic strikethrough forecolor backcolor | fontfamily fontsize blocks | link | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat undo redo"
            {%endif%}
          });
        },
        error: function(errMsg) {
          toast(errMsg["responseJSON"]["message"],"error")
        }
    })
}
function addCommentToDiv(comment) {
  user_id = {{current_user.id}};
  if (user_id === comment.author_id) {
    delete_str = `<div class="dropdown dropdown-end"><label tabindex="0" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM12.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM18.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></label><ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 text-error"><li><a @click="deleteComment(${comment.id})">Delete</a></li></ul></div>`
  } else {
    delete_str = ""
  }
  var record = `
    <article id="comment-${comment.id}" class="py-6 mb-6 rounded-lg border-b border-base-200">
        <footer class="flex justify-between items-center mb-2">
            <div class="flex items-center text-sm">
                <div class="avatar placeholder mr-2"><div class="bg-neutral-focus text-neutral-content rounded-full w-6"><span class="text-xs uppercase">${comment.author_email[0]}</span></div></div>${comment.author_email}
                <p class="inline-flex items-center mr-3 text-sm"></p>
                <p class="text-xs font-semibold"><time pubdate="">${comment.date_added}</time></p>
            </div>${delete_str}
        </footer>
        <p class="">${comment.message}</p>
    </article>
  `
  $("#comments").prepend(record)
}
function deleteComment(id) {
    $.ajax({
        type: "DELETE",
        url: `/api/v1/projects/{{project.id}}/comments/${id}`,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
            $(`#comment-${id}`).remove()
            toast("Deleted comment")
            return(data)
        },
        error: function(errMsg) {
            return(errMsg);
        }
    })
}
function saveComment(e) {
    var value = document.getElementById("comment").value;
    if (!value) {
      return
    }
    disableButton('.add-project-comment-btn');
    $.ajax({
        type: "POST",
        url: `/api/v1/projects/{{project.id}}/comments`,
        data: JSON.stringify({"data":value}),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
            addCommentToDiv(data)
            document.getElementById("comment").value = ""
            toast("Added comment")
            loadComments()
            return(data)
        },
        error: function(errMsg) {
            toast(errMsg["responseJSON"]["message"],"error")
            return(errMsg);
        },
        complete: function() {
            enableButton('.add-project-comment-btn');
        },
    })
}
function loadReport() {
  $("#card-div").html('<div class="col-span-9 mx-auto mt-10 flex flex-row">Coming Soon!</div>');
  return
}
function loadComments() {
    {%if is_auditor and not project.can_auditor_read_comments%}
    toast("You lack permissions to view the comments.","warning")
    $("#card-div").html('<div class="col-span-9 mx-auto mt-10 flex flex-row">Insufficient Permissions<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.182 16.318A4.486 4.486 0 0012.016 15a4.486 4.486 0 00-3.198 1.318M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" /></svg></div>')
    return
    {%endif%}
    $("#card-div").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
    $.ajax({
        type: "GET",
        url: "/api/v1/projects/{{project.id}}/comments",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
        $("#card-div").html(`<div class="col-span-9">
          <div class="mb-4 justify-between flex">
            <div>
              <h1 class="text-2xl font-bold">Comments<span id="comment-count" class="ml-2"></span></h1>
              <p class="text-sm">Comments are used to discuss generals topics about the project. {%if project.can_auditor_read_comments%}The auditor <b>can read</b> the comments.{%else%} The auditor <b>can not read</b> the comments.{%endif%}</p>
            </div>
            {%if not auditor or project.project.can_auditor_write_comments%}
            <div class="my-auto flex justify-between gap-x-2">
              <button @click="saveComment" class="btn btn-sm btn-primary add-project-comment-btn">Send</button>
            </div>
            {%endif%}
          </div>
          <div class="mb-5">
            <textarea id="comment" rows="4" class="textarea textarea-bordered w-full text-sm" placeholder="Write a comment..." required=""></textarea>
            <div class=" h-[calc(100vh-500px)] overflow-auto px-3" id="comments"></div>
          </div>
        </div>`)
          $("#comments").html("")
          $("#comment-count").html(`(${data.length})`)
          if (data) {
            $("#comments-title").html(`(${data.length})`)
          }
          for (var comment in data) {
            addCommentToDiv(data[comment])
          }
          mention_options = [];
          var users = JSON.parse(localStorage.getItem("tenant-users-{{project.tenant_id}}"));
          for(user in users) {
            mention_options.push({key:users[user].email, value:users[user].username})
          }
          var tribute = new Tribute({values:mention_options});
          tribute.attach(document.getElementById("comment"));
        },
        error: function(errMsg) {
          toast(errMsg["responseJSON"]["message"],"error")
        }
    })


}
function loadSummary() {
  $("#summary-div").html("");
  var url = new URL(location.protocol + '//' + location.host + "/api/v1/projects/{{project.id}}?review-summary=true");

  var summary_alert = `
<div class="alert alert-primary shadow-sm border border-base-300 rounded-md">
  <div>
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current flex-shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    <span>Get started by <a class="underline text-primary" href="{{url_for("main.view_project",pid=project.id,tab='controls')}}">viewing the controls in your project.</a> Add members & auditors to your project under <a class="underline text-primary" href="{{url_for("main.view_project",pid=project.id,tab='settings')}}">settings.</a> You can also view the responsibilities for each control <a class="underline text-primary" href="{{url_for("main.view_project",pid=project.id,tab='matrix')}}">under the matrix.</a> </span>
  </div>
</div>
` 

  $("#card-div").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
  $.ajax({
    type: "GET",
    url: url.toString(),
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){
      $("#card-div").html("");
	  var complete_options = {
            series: [100-data.completion_progress,data.completion_progress],
            legend: {
	      show: false
	    },
            dataLabels: {
              enabled: false
            },
	    chart: {
	      type: 'donut',
              height: 200
              //redrawOnParentResize: true
	    },
plotOptions: {
    pie: {
      donut: {
        labels: {
          show: true,
        value:{
          offsetY: -8,
          color:'#6b6a6e'
        },
          total: {
            show: true,
            label: '',
            formatter: () => `${data.completion_progress}%`
          }
        }
      }
    }
  },
            labels: ['Uncomplete', 'Complete'],
            fill:{colors:['#f3f4f6', '#4ade80']},
            responsive: [{
	      breakpoint: 300,
	      options: {
	        chart: {
	          width: 100
	        }
	      }
  	    }]
	  };
	  var implemented_options = {
            series: [100-data.implemented_progress,data.implemented_progress],
            legend: {
	      show: false
	    },
            dataLabels: {
              enabled: false
            },
	    chart: {
	      type: 'donut',
              height: 200
              //redrawOnParentResize: true
	    },
plotOptions: {
    pie: {
      donut: {
        labels: {
          show: true,
        value:{
          offsetY: -8,
          color:'#6b6a6e'
        },
          total: {
            show: true,
            label: '',
            formatter: () => `${data.implemented_progress}%`
          }
        }
      }
    }
  },
            labels: ['Uncomplete', 'Complete'],
            fill:{colors:['#f3f4f6', '#4ade80']},
            responsive: [{
	      breakpoint: 300,
	      options: {
	        chart: {
	          width: 100
	        }
	      }
  	    }]
	  };
	  var evidence_options = {
            series: [100-data.evidence_progress,data.evidence_progress],
            legend: {
	      show: false
	    },
            dataLabels: {
              enabled: false
            },
	    chart: {
	      type: 'donut',
              height: 200
              //redrawOnParentResize: true
	    },
plotOptions: {
    pie: {
      donut: {
        labels: {
          show: true,
        value:{
          offsetY: -8,
          color:'#6b6a6e'
        },
          total: {
            show: true,
            label: '',
            formatter: () => `${data.evidence_progress}%`
          }
        }
      }
    }
  },
            labels: ['Uncomplete', 'Complete'],
            fill:{colors:['#f3f4f6', '#4ade80']},
            responsive: [{
              breakpoint: 300,
	      options: {
	        chart: {
	          width: 100
	        }
	      }
  	    }]
	  };
          var review_complete = Number(parseFloat(((data.review_summary["complete"]||0)/data.review_summary["total"])*100).toFixed(2));
	  var review_options = {
            series: [100-review_complete,review_complete],
            legend: {
	      show: false
	    },
            dataLabels: {
              enabled: false
            },
	    chart: {
	      type: 'donut',
              height: 200
              //redrawOnParentResize: true
	    },
plotOptions: {
    pie: {
      donut: {
        labels: {
          show: true,
        value:{
          offsetY: -8,
          color:'#6b6a6e'
        },
          total: {
            show: true,
            label: '',
            formatter: () => `${review_complete}%`
          }
        }
      }
    }
  },
            labels: ['Uncomplete', 'Complete'],
            fill:{colors:['#f3f4f6', '#4ade80']},
            responsive: [{
              breakpoint: 300,
	      options: {
	        chart: {
	          width: 100
	        }
	      }
  	    }]
	  };
          $("#card-div").append(`<div class="col-span-9 mb-2">${summary_alert}</div>`)

          $("#card-div").append(`<div class="grid grid-cols-8 col-span-full gap-x-4">
            <div class="col-span-2"><div class="card border border-base-300"><div class="p-5"><h2 class="card-title capitalize text-lg"><div class="tooltip w-full" data-tip="Progress of your project completion">Complete Progress</div></h2><div class="text-center"><div id="complete-progress"></div></div></div></div></div>
            <div class="col-span-2"><div class="card border border-base-300"><div class="p-5"><h2 class="card-title capitalize text-lg"><div class="tooltip w-full" data-tip="Progress of controls that are implemented">Controls Implemented</div></h2><div class="text-center"><div id="implemented-progress"></div></div></div></div></div>
            <div class="col-span-2"><div class="card border border-base-300"><div class="p-5"><h2 class="card-title capitalize text-lg"><div class="tooltip w-full" data-tip="Progress of evidence collected for controls">Evidence Gathered</div></h2><div class="text-center"><div id="evidence-progress"></div></div></div></div></div>
            <div class="col-span-2"><div class="card border border-base-300"><div class="p-5"><h2 class="card-title capitalize text-lg"><div class="tooltip w-full" data-tip="Progress between InfoSec and Auditor">Controls Reviewed</div></h2><div class="text-center"><div id="review-progress"></div></div></div></div></div>
          </div>`)

          var auditor_alert = "";
          if (data.auditors === undefined || data.auditors.length == 0) {
            var auditor_alert = `<div class="alert shadow-sm mb-2"><div><span>Please <a class="underline text-primary" href="/projects/{{project.id}}?tab=settings">add an auditor</a> to your project.</span></div></div>`;
          }

          $("#card-div").append(`<div class="grid grid-cols-6 col-span-full gap-x-4">
            <div class="col-span-3">
<div class="card border border-base-300">
  <div class="card-body">
    <div class="card-title mb-4 justify-between">
      <h2 class="card-title">InfoSec Summary</h2>
      <div>
        <a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls" class="btn btn-sm btn-ghost border border-base-300">View Controls<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></a>
      </div>
    </div>
    <div class="font-medium text-md">
<div class="overflow-x-auto">
  <table class="table w-full">
    <thead>
      <tr>
        <th>Metric</th>
        <th># of Controls</th>
        <th>View</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><div class="tooltip tooltip-right" data-tip="Control has not been started">Not Started</div></td>
        <td>${data.review_summary["not started"]||0}</td>
        <td><a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls&grouping=subcontrols&filter=12" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /></svg></a></td>
      </tr>
      <tr>
        <td><div class="tooltip tooltip-right" data-tip="InfoSec team is working on the control">InfoSec Action</div></td>
        <td>${data.review_summary["infosec action"]||0}</td>
        <td><a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls&grouping=subcontrols&filter=13" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /></svg></a></td>
      </tr>
      <tr>
        <td><div class="tooltip tooltip-right" data-tip="Auditor says that Action is required from you">Action Required</div></td>
        <td>${data.review_summary["action required"]||0}</td>
        <td><a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls&grouping=subcontrols&filter=14" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /></svg></a></td>
      </tr>
    </tbody>
  </table>
</div>
    </div>
  </div>
</div>
            </div>
            <div class="col-span-3">
<div class="card border border-base-300">
  <div class="card-body">
    <div class="card-title mb-4 justify-between">
      <h2 class="card-title">Auditor Summary</h2>
      <div>
        <a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls" class="btn btn-sm btn-ghost border border-base-300">View Controls<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></a>
      </div>
    </div>
    ${auditor_alert}
    <div class="font-medium text-md">
<div class="overflow-x-auto">
  <table class="table w-full">
    <thead>
      <tr>
        <th>Metric</th>
        <th># of Controls</th>
        <th>View</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><div class="tooltip tooltip-right" data-tip="Control is waiting for the auditor to review">Ready for Auditor</div></td>
        <td>${data.review_summary["ready for auditor"]||0}</div></td>
        <td><a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls&grouping=subcontrols&filter=15" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /></svg></a></td>
      </tr>
      <tr>
        <td><div class="tooltip tooltip-right" data-tip="Auditor has marked the review as complete">Complete</div></td>
        <td>${data.review_summary["complete"]||0}</td>
        <td><a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls&grouping=subcontrols&filter=16" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /></svg></a></td>
      </tr>
    </tbody>
  </table>
</div>

    </div>
  </div>
</div>
            </div>
          </div>`);

          $("#card-div").append(`
            <div class="col-span-9"><div class="overflow-hidden shadow sm:rounded-lg border border-base-200"><div class="px-4 py-6 sm:px-6"><h3 class="text-lg font-medium leading-6">Project Details</h3><p class="mt-1 max-w-2xl text-sm">Overview of your project details and status</p></div><div class="border-t border-base-300"><div class="grid grid-cols-9 px-6 py-5 gap-y-8">
            <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Name</strong><span class="text-sm capitalize">${data.name}</span></div></div>
            <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Tenant</strong><span class="text-sm capitalize">${data.tenant}</span></div></div>
            <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Framework</strong><a href="/frameworks/${data.framework}" class="text-sm uppercase text-primary bg-base-200 rounded-full py-1 px-3 w-fit">${data.framework}</a></div></div>
            <div class="col-span-9"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Description</strong><span class="text-sm rounded-md border border-base-200 p-4 mt-2">${data.description}</span></div></div>
            <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Owner</strong><span class="text-sm">${data.owner}</span></div></div>
            <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Controls</strong><span class="text-sm">${data.total_controls}</span></div></div>
            <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Policies</strong><span class="text-sm">${data.total_policies}</span></div></div>
            <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Creation</strong><span class="text-sm">${data.date_added}</span></div></div>
          </div></div></div></div>`);
          $("#project-details").append(`<div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"><dt class="text-sm font-medium">Name</dt><dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">${data.name}</dd></div>`)
          $("#complete-progress").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
          $("#implemented-progress").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
          $("#evidence-progress").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
          $("#review-progress").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
          var complete_chart = new ApexCharts(document.querySelector("#complete-progress"), complete_options);
          var implemented_chart = new ApexCharts(document.querySelector("#implemented-progress"), implemented_options);
          var evidence_chart = new ApexCharts(document.querySelector("#evidence-progress"), evidence_options);
          var review_chart = new ApexCharts(document.querySelector("#review-progress"), review_options);

          setTimeout(() => {
            $("#complete-progress").html("");
            $("#implemented-progress").html("");
            $("#evidence-progress").html("");
            $("#review-progress").html("");
            complete_chart.render();
            implemented_chart.render();
            evidence_chart.render();
            review_chart.render();
          }, 200);

          return(data);
    },
    error: function(errMsg) {
        return(errMsg);
    }
  })
}

function loadEvidence() {
      //load evidence in table format for the project
      $("#card-div").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
      $("#card-div").html("");
      // top left
      $("#card-div").append('<div class="col-span-3"><div class="card shadow border border-base-200"><div class="p-5"><h2 class="card-title capitalize text-lg">Evidence Progress</h2><div class="text-center"><div id="evidence-progress"></div></div></div></div></div>')
      $("#evidence-progress").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
      $.ajax({
        type: "GET",
        url: "/api/v1/projects/{{project.id}}",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
	  var evidence_options = {
            series: [100-data.evidence_progress,data.evidence_progress],
            legend: {
	      show: false
	    },
            dataLabels: {
              enabled: false
            },
	    chart: {
	      type: 'donut',
              height: 350
	    },
            plotOptions: {
                pie: {
                  donut: {
                    labels: {
                      show: true,
                    value:{
                      offsetY: -8,
                      color:'#6b6a6e'
                    },
                      total: {
                        show: true,
                        label: '',
                        formatter: () => `${data.evidence_progress}%`
                      }
                    }
                  }
                }
            },
            labels: ['Uncomplete', 'Complete'],
            fill:{colors:['#f3f4f6', '#4ade80']},
            responsive: [{
              breakpoint: 300,
	      options: {
	        chart: {
	          width: 100
	        }
	      }
  	    }]
	  };
          var evidence_chart = new ApexCharts(document.querySelector("#evidence-progress"), evidence_options);

          setTimeout(() => {
            $("#evidence-progress").html("")
            evidence_chart.render();
          },2000)
        },
        error: function(errMsg) {
          return(errMsg);
        }
      });

      $("#card-div").append(`<div class="col-span-6"><div class="card shadow-md card-body border border-base-300"><div class=""><h2 class="card-title mb-4">Evidence by Controls</h2><table class="table table-vcenter " id="evidence-table" style="width:100%"><thead><tr><th class="bg-base-200">Name</th><th class="w-1 bg-base-200"># of Controls</th></tr></thead><tbody id="evidence-table-body"></tbody></table></div></div></div>`);
      $.ajax({
        type: "GET",
        url: "/api/v1/projects/{{project.id}}/evidence/controls",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
          for (var record in data) {
            $("#evidence-table-body").append(`<tr><td class="text-sm font-medium capitalize whitespace-normal">${clean(data[record].name)}</td><td class="text-sm font-semibold">${data[record].count}</td></tr>`);
          }
          $("#evidence-table").DataTable({"pageLength":10,"order": [[ 0, "desc" ]]});

        },
        error: function(errMsg) {
        }
      })
}

  /** Region: Controls & Subcontrols */

  function buildSubControlsTable(data) {
    const params = new window.URLSearchParams(window.location.search);
    const filter = params.get("filter");
    const grouping = params.get("grouping");
    const owner = params.get("owner");
    const operator = params.get("operator");

    const subSelectOptions = getControlsFilterSelectOptions();
    const selectGroupingOptions = getGroupingFilterSelectOptions();
    const subSelectList = `<select class="select select-sm select-bordered controls-filter">${subSelectOptions}</select>`;
    const selectGrouping = `<select class="select select-sm select-bordered grouping-filter">${selectGroupingOptions}</select>`;
    const selectOwner = (`
      <div>
        <input @blur="blurOwnerFilter" type="text" placeholder="Search Owner" class="input input-bordered input-sm w-full owner-filter" />
      </div>
    `);
    const selectOperator = (`
      <div>
        <input @blur="blurOperatorFilter" type="text" placeholder="Search Operator" class="input input-bordered input-sm w-full operator-filter" />
      </div>
    `);
    
    $("#card-div").html(`
      <div class="col-span-9">
        <div class="card shadow-md card-body border border-base-300 p-5">
          <div>
            <div class="justify-between flex">
              <div>
                <h2 class="card-title mb-4 control-title"></h2>
              </div>
              <div class="flex flex-row gap-x-2">
                ${selectOwner}
                ${selectOperator}
                <div>${selectGrouping}</div>
                ${subSelectList}
                <div class="space-x-2">
                  <button class="btn btn-sm btn-ghost border border-base-300 capitalize reload-button tooltip" data-tip="Refresh Data">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-green-600">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                  </button>
                  <button class="btn btn-sm btn-ghost border border-base-300 capitalize remove-control-filter tooltip" data-tip="Remove Filter">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-red-600">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            <table class="table table-vcenter " id="project-table" style="width:100%">
              <thead>
                <tr>
                  <th class="bg-base-200">ID</th>
                  <th class="bg-base-200">Ref Code</th>
                  <th class="bg-base-200">Subcontrol</th>
                  <th class="bg-base-200 w-1">
                    <div class="tooltip" data-tip="Owner/Operator">O/Op</div>
                  </th>
                  <th class="bg-base-200 w-1">Complete</th>
                  <th class="bg-base-200 w-1">
                    <div class="tooltip" data-tip="Review status with auditor">Review</div>
                  </th>
                  <th class="bg-base-200 w-1">
                    <div class="tooltip" data-tip="Progress of the control">Progress</div>
                  </th>
                  <th class="bg-base-200 w-1">
                    <div class="tooltip" data-tip="Action Items from Auditor">Todo</div>
                  </th>
                  <th class="bg-base-200 w-1">Evidence</th>
                  <th class="bg-base-200 w-1">View</th>
                </tr>
              </thead>
              <tbody id="project-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    `);
    
    $(".controls-filter").val(filter ? filter : "all");
    $(".grouping-filter").val(grouping);
    $(".owner-filter").val(owner);
    $(".operator-filter").val(operator);

    for (let i in data) {
      const subcontrol = data[i];
      const completeColor = subcontrol.is_complete ? "green" : "red";
      const reviewColor = getSubControlStatusColor(subcontrol.review_status);
      const evidenceIcon = subcontrol.has_evidence ? iconCheckmark : iconNegative;
      const completeIcon = subcontrol.is_applicable ? (subcontrol.is_complete ? iconCheckmark : iconNegative) : iconNotApplicable;
      const ownerAvatar = (subcontrol.owner && !subcontrol.owner.startsWith("Missing")) ? iconAvatar(subcontrol.owner) : iconNoAvatar;
      const operatorAvatar = (subcontrol.operator && !subcontrol.operator.startsWith("Missing")) ? iconAvatar(subcontrol.operator) : iconNoAvatar;
      
      $("#project-table-body").append(`
        <tr>
          <td class="text-sm font-medium">${subcontrol.id}</td>
          <td class="text-sm font-medium uppercase">
            <p class="text-primary bg-base-200 rounded-full py-1 px-3 w-fit">${clean(subcontrol.ref_code)}</p>
          </td>
          <td class="text-sm font-medium whitespace-normal">${clean(subcontrol.name)}</td>
          <td>
            <div data-id="${subcontrol.id}" data-owner="${subcontrol.owner}" data-operator="${subcontrol.operator}" class="avatar-group -space-x-4 cursor-pointer transform transition duration-500 hover:scale-110 populate-owner-modal">${ownerAvatar}${operatorAvatar}</div>
          </td>
          <td class="text-sm font-medium capitalize text-center">${completeIcon}</td>
          <td class="text-sm font-medium capitalize">
            <p class="py-1 px-3 w-fit text-${reviewColor}-600 bg-${reviewColor}-400/10 rounded-full">${subcontrol.review_status}</p>
          </td>
          <td class="text-sm font-medium capitalize text-center">${subcontrol.implemented}%</td>
          <td class="text-sm font-medium text-center">${subcontrol.complete_feedback}/${subcontrol.feedback}</td>
          <td>${evidenceIcon}</td>
          <td class="text-sm font-medium">
            <a target="_blank" rel="noopener noreferrer" class="btn btn-xs btn-ghost" href="/projects/${subcontrol.project_id}/controls/${subcontrol.project_control_id}/subcontrols/${subcontrol.id}">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
              </svg>
            </a>
          </td>
        </tr>
      `);
    }
    table = $("#project-table").DataTable({"pageLength": 25, "order": [[0, "asc"]]});
    $(".control-title").html(`Project Subcontrols (${data.length})`);
  }

  function buildControlsTable(data) {
    const params = new window.URLSearchParams(window.location.search);
    const filter = params.get("filter");
    const grouping = params.get("grouping");

    const subSelectOptions = getControlsFilterSelectOptions();
    const selectGroupingOptions = getGroupingFilterSelectOptions();
    const selectList = `<select class="select select-sm select-bordered controls-filter">${subSelectOptions}</select>`;
    const selectGrouping = `<select class="select select-sm select-bordered grouping-filter">${selectGroupingOptions}</select>`;
    const modalIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>`;
    
    $("#card-div").html(`
      <div class="col-span-9">
        <div class="card shadow-md card-body border border-base-300 p-5">
          <div>
            <div class="justify-between flex">
              <div>
                <h2 class="card-title mb-4">Project Controls (${data.length})</h2>
              </div>
              <div class="flex flex-row gap-x-2">
                <div>${selectGrouping}</div>
                ${selectList}
                <div class="space-x-2">
                  <button class="btn btn-sm btn-ghost border border-base-300 capitalize reload-button tooltip" data-tip="Refresh data">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-green-600">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                  </button>
                  <button class="btn btn-sm btn-ghost border border-base-300 capitalize remove-control-filter tooltip" data-tip="Remove filter">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-red-600">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            <table class="table table-vcenter " id="project-table" style="width:100%">
              <thead>
                <tr>
                  <th class="w-1 bg-base-200">ID</th>
                  <th class="w-1 bg-base-200">Ref Code</th>
                  <th class="bg-base-200">Name</th>
                  <th class="w-1 bg-base-200">
                    <div class="tooltip" data-tip="Status of the control">Status</div>
                  </th>
                  <th class="w-1 bg-base-200">
                    <div class="tooltip" data-tip="Review status with auditor">Review</div>
                  </th>
                  <th class="w-1 bg-base-200">
                    <div class="tooltip" data-tip="Action items from auditor">Todo</div>
                  </th>
                  <th class="w-1 bg-base-200">
                    <div class="tooltip" data-tip="% of control implemented">Implemented</div>
                  </th>
                  <th class="w-1 bg-base-200">View</th>
                </tr>
              </thead>
              <tbody id="project-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    `);
    
    $(".controls-filter").val(filter ? filter : "all");
    $(".grouping-filter").val(grouping);

    for (let i in data) {
      const control = data[i]
      const statusColor = getControlStatusColor(control.status);
      const totalReviews = control.stats.subcontrols;
      const totalFeedback = control.stats.feedback;
      const completeReviews = control.stats.subcontrols_complete
      const completeFeedback = 0;

      const controlRow = (`
        <tr data-project-id="${control.project_id}" data-control-id="${control.id}">
          <td class="text-sm font-medium uppercase dt-control">
            <b class="ml-2">${control.id}</b>
          </td>
          <td class="text-sm font-medium uppercase">
            <p class="text-primary bg-base-200 rounded-full py-1 px-3 w-fit">${clean(control.ref_code)}</p>
          </td>
          <td class="text-sm font-medium whitespace-normal capitalize">${clean(control.name)}</td>
          <td class="text-sm font-medium capitalize">
            <p class="text-${statusColor}-600 bg-${statusColor}-400/10 rounded-full py-1 px-3 w-fit">${control.status}</p>
          </td>
          <td class="text-sm font-medium text-center">${completeReviews}/${totalReviews}</td>
          <td>
            <div class="text-sm font-medium text-center">${completeFeedback}/${totalFeedback}</div>
          </td>
          <td>
            <div class="flex flex-col">
              <b class="text-xs font-medium">${control.progress_implemented}</b>
              <progress class="progress progress-primary w-28" value="${control.progress_implemented}" max="100"/>
            </div>
          </td>
          <td class="">
            <a data-id="${control.id}" class="btn btn-xs btn-ghost control-modal-btn" href="#">${modalIcon}</a>
          </td>
        </tr>
      `);

      $("#project-table-body").append(controlRow);

      localStorage.setItem(`grc-project-${control.project_id}-control-${control.id}`, JSON.stringify(control));
    }

    $("#project-table tbody").on("click", "td.dt-control", function () {
      const tr = $(this).closest("tr");
      const row = table.row(tr);
      const projectId = tr.data("project-id");
      const controlId = tr.data("control-id");

      if (row.child.isShown()) {
        row.child.hide();
        tr.removeClass("shown");
      } else {
        row.child(populateSubcontrolList(projectId, controlId)).show();
        tr.addClass("shown");
      }
    });
    
    const table = $("#project-table").DataTable({
      "pageLength": 25,
      "order": [[0, "asc"]],
    });
  }

  function populateSubcontrolList(projectId, controlId) {
    const control = JSON.parse(localStorage.getItem(`grc-project-${projectId}-control-${controlId}`));    
    let subControlsBody = "";

    for (let i in control.subcontrols) {
      const subcontrol = control.subcontrols[i];
      const completeColor = subcontrol.is_complete ? "green" : "red";
      const reviewColor = getSubControlStatusColor(subcontrol.review_status);
      const evidenceIcon = subcontrol.has_evidence ? iconCheckmark : iconNegative;
      const completeIcon = subcontrol.is_applicable ? (subcontrol.is_complete ? iconCheckmark : iconNegative) : iconNotApplicable;
      const ownerAvatar = (subcontrol.owner && !subcontrol.owner.startsWith("Missing")) ? iconAvatar(subcontrol.owner) : iconNoAvatar;
      const operatorAvatar = (subcontrol.operator && !subcontrol.operator.startsWith("Missing")) ? iconAvatar(subcontrol.operator) : iconNoAvatar;

      subControlsBody += (`
        <tr>
          <td class="text-sm font-medium capitalize text-center">
            <b class="ml-2">${subcontrol.id}</b>
          </td>
          <td class="text-sm font-medium whitespace-normal">${subcontrol.name}</td>
          <td>
            <div data-id="${subcontrol.id}" data-owner="${subcontrol.owner}" data-operator="${subcontrol.operator}" class="avatar-group -space-x-4 cursor-pointer transform transition duration-500 hover:scale-110 populate-owner-modal">${ownerAvatar}${operatorAvatar}</div>
          </td>
          <td class="text-sm font-medium capitalize text-center">${completeIcon}</td>
          <td class="text-sm font-medium capitalize">
            <p class="py-1 px-3 w-fit text-${reviewColor}-600 bg-${reviewColor}-400/10 rounded-full">${subcontrol.review_status}</p>
          </td>
          <td class="text-sm font-medium capitalize text-center">${subcontrol.implemented}%</td>
          <td class="text-sm font-medium text-center">${subcontrol.complete_feedback}/${subcontrol.feedback}</td>
          <td>${evidenceIcon}</td>
          <td class="text-sm font-medium">
            <a
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-xs btn-ghost"
              href="/projects/${subcontrol.project_id}/controls/${subcontrol.project_control_id}/subcontrols/${subcontrol.id}"
            >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
              </svg>
            </a>
          </td>
        </tr>
      `);
    }

    return (`
      <div class="col-span-9">
        <div class="card card-body border border-slate-200">
          <div class="justify-between flex mb-2 my-auto">
            <div>
              <h2 class="card-title mb-2">Details</h2>
              <p class="text-sm">View the subcontrols below and the summary details.</p>
            </div>
            <div>
              <a href="/projects/${control.project_id}/controls/${control.id}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-primary">View Control</a>
            </div>
          </div>
          <div class="grid grid-cols-10 gap-x-2 gap-y-5"><div class="col-span-2">
            <div class="flex items-start rounded-xl py-4 px-3 border border-base-300">
              <div class="flex h-8 w-8 my-auto items-center justify-center rounded-full bg-base-200 border border-base-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-400 w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/>
                </svg>
              </div>
              <div class="ml-4">
                <h2 class="font-semibold">Complete</h2>
                <p class="mt-2 text-sm">${control.stats.subcontrols_complete}/${control.stats.subcontrols} complete</p>
              </div>
            </div>
          </div>
          <div class="col-span-2">
            <div class="flex items-start rounded-xl py-4 px-3 border border-base-300">
              <div class="flex h-8 w-8 my-auto items-center justify-center rounded-full bg-base-200 border border-base-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-400 w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </div>
              <div class="ml-4">
                <h2 class="font-semibold">Inapplicable</h2>
                <p class="mt-2 text-sm">${control.stats.inapplicable_subcontrols}/${control.stats.subcontrols} inapplicable</p>
              </div>
            </div>
          </div>
          <div class="col-span-2">
            <div class="flex items-start rounded-xl py-4 px-3 border border-base-300">
              <div class="flex h-8 w-8 my-auto items-center justify-center rounded-full bg-base-200 border border-base-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-400 w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/>
                </svg>
              </div>
              <div class="ml-4">
                <h2 class="font-semibold">Feedback</h2>
                <p class="mt-2 text-sm">${control.stats.feedback} action items</p>
              </div>
            </div>
          </div>
          <div class="col-span-2">
            <div class="flex items-start rounded-xl py-4 px-3 border border-base-300">
              <div class="flex h-8 w-8 my-auto items-center justify-center rounded-full bg-base-200 border border-base-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-400 w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z"/>
                </svg>
              </div>
              <div class="ml-4">
                <h2 class="font-semibold">Comments</h2>
                <p class="mt-2 text-sm">${control.stats.comments} comments</p>
              </div>
            </div>
          </div>
          <div class="col-span-2">
            <div class="flex items-start rounded-xl py-4 px-3 border border-base-300">
              <div class="flex h-8 w-8 my-auto items-center justify-center rounded-full bg-base-200 border border-base-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-400 w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"/>
                </svg>
              </div>
              <div class="ml-4">
                <h2 class="font-semibold">Evidence</h2>
                <p class="mt-2 text-sm">${control.stats.evidence} evidence</p>
              </div>
            </div>
          </div>
          <div class="col-span-10"><div class="overflow-x-auto">
            <table class="table w-full">
              <thead>
                <tr>
                  <th class="bg-base-200 w-1">ID</th>
                  <th class="bg-base-200 w-1">Subcontrol Name</th>
                  <th class="bg-base-200 w-1">
                    <div class="tooltip tooltip-right" data-tip="Owner/Operator">O/OP</div>
                  </th>
                  <th class="bg-base-200 w-1">Complete</th>
                  <th class="bg-base-200 w-1">
                    <div class="tooltip tooltip-right" data-tip="Review status with auditor">Review</div>
                  </th>
                  <th class="bg-base-200 w-1">
                    <div class="tooltip tooltip-right" data-tip="Progress of the control">Progress</div>
                  </th>
                  <th class="bg-base-200 w-1">
                    <div class="tooltip tooltip-left" data-tip="Action items from auditor">Todo</div>
                  </th>
                  <th class="bg-base-200 w-1">Evidence</th>
                  <th class="bg-base-200 w-1">View</th>
                </tr>
              </thead>
              <tbody>${subControlsBody}</tbody>
            </table>
          </div>
        </div>
        <div class="col-span-10">
          <div class="overflow-x-auto">
            <table class="table w-full">
              <thead>
                <tr>
                  <th class="w-2 bg-base-200">Key</th>
                  <th class="bg-base-200">Value</th>
                </tr>
              </thead>
            <tbody>
              <tr>
                <td class="text-sm font-medium text-primary">Description</td>
                <td class="whitespace-normal text-sm font-medium">${control.description}</td>
              </tr>
              <tr>
                <td class="text-sm font-medium text-primary">Status</td>
                <td class="whitespace-normal text-sm font-medium capitalize">${control.status}</td>
              </tr>
              <tr>
                <td class="text-sm font-medium text-primary">Applicable</td>
                <td class="whitespace-normal text-sm font-medium capitalize">${control.is_applicable}</td>
              </tr>
              <tr>
                <td class="text-sm font-medium text-primary">Complete</td>
                <td class="whitespace-normal text-sm font-medium capitalize">${control.is_complete}</td>
              </tr>
              <tr>
                <td class="text-sm font-medium text-primary">Reference</td>
                <td class="whitespace-normal text-sm font-medium capitalize">${control.ref_code}</td>
              </tr>
              <tr>
                <td class="text-sm font-medium text-primary">Category</td>
                <td class="whitespace-normal text-sm font-medium capitalize">${control.category}</td>
              </tr>
              <tr>
                <td class="text-sm font-medium text-primary">Subcategory</td>
                <td class="whitespace-normal text-sm font-medium capitalize">${control.subcategory}</td>
              </tr>
              <tr>
                <td class="text-sm font-medium text-primary">Updated</td>
                <td class="whitespace-normal text-sm font-medium capitalize">${control.date_updated}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    `);
  }

  function loadControls(reload=false) {
    const params = new window.URLSearchParams(window.location.search);
    const grouping = params.get("grouping");
    const filter = params.get("filter");
    const owner = params.get("owner");
    const operator = params.get("operator");
    const projectId = "{{project.id}}"

    const apiUrl = `/api/v1/projects/${projectId}`;
    let url = null;

    switch (grouping) {
      case (controlsGrouping.SUBCONTROLS):
        url = `${apiUrl}/${controlsGrouping.SUBCONTROLS}`;
        break;
      case (controlsGrouping.CONTROLS):
        url = `${apiUrl}/${controlsGrouping.CONTROLS}`;
        break;
      default:
        setDefaultGrouping();
        url = `${apiUrl}/${controlsGrouping.CONTROLS}`;
    }

    $("#card-div").html(cardBlock);

    const queryParams = [
      filter && `filter=${filter}`,
      owner && `owner=${owner}`,
      operator && `operator=${operator}`
    ].filter(Boolean);

    if (queryParams.length > 0) {
      url += `?${queryParams.join('&')}`;
    }

    $.ajax({
      type: "GET",
      url: url,
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: function(data) {
        (grouping == controlsGrouping.SUBCONTROLS) ? buildSubControlsTable(data) : buildControlsTable(data);
        updateActiveQuickFilter();
        return(data);
      },
      error: function(errMsg) {
        (grouping == controlsGrouping.SUBCONTROLS) ? buildSubControlsTable([]) : buildControlsTable([]);
        toast(errMsg["responseJSON"]["message"],"error");
        return(errMsg);
      }
    });

    $("#card-div").html(cardBlock);
  }

  /** EndRegion: Controls & Subcontrols */


function loadPolicies() {
  //load policies in table format for the project
  $("#card-div").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
  $.ajax({
    type: "GET",
    url: "/api/v1/projects/{{project.id}}/policies",
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){
      $("#card-div").html("");
      $("#card-div").html(`<div class="col-span-9"><div class="card shadow-md card-body border border-base-300"><div class=""><h2 class="card-title mb-4">Project Policies</h2><table class="table table-vcenter " id="project-table" style="width:100%"><thead><tr><th class="w-1 bg-base-200">Name</th><th class="bg-base-200">Description</th><th class="w-1 bg-base-200">Ref Code</th><th class="w-1 bg-base-200">Public</th><th class="w-1 bg-base-200">View</th></tr></thead><tbody id="project-table-body"></tbody></table></div></div></div>`);
      for (var record in data) {
        var obj = data[record];

        if (obj.ref_code) {
          var ref_code = obj.ref_code
        } else {
          var ref_code = "?"
        }
        $("#project-table-body").append(`<tr><td class="text-sm font-medium whitespace-normal capitalize">${clean(obj.name)}</td><td class="text-sm font-medium capitalize">${clean(obj.description)}</td><td class="text-sm font-medium capitalize"><p class="bg-base-200 rounded-full py-1 px-3 w-fit">${ref_code}</p></td><td class="text-sm font-medium"><p class="bg-base-200 rounded-full py-1 px-3 capitalize w-fit">${obj.public_viewable}</p></td><td class=""><a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}/policies/${obj.id}" data-id="${obj.id}" class="btn btn-xs btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></a></td></tr>`);
      }
      $("#project-table").DataTable({"pageLength":25,"order": [[ 0, "desc" ]]});
      if (data === undefined || data.length == 0) {
        $("#card-div").prepend('<div class="alert shadow-lg col-span-9 alert-warning px-8 rounded-md"><div><div><h3 class="font-bold">Your project does not have any policies!</h3> <div class="text-xs">Please add policies to your project</div> </div> </div> <div class="flex-none"> <a href="{{url_for("main.policies")}}" class="btn btn-sm btn-ghost">Add Policies</a> </div> </div>');
      }
      return(data)
    },
    error: function(errMsg) {
        return(errMsg);
    }
  })
}

function loadMembers() {
  $.ajax({
    type: "GET",
    url: "/api/v1/projects/{{project.id}}/members",
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){
      $("#card-div").append(`<div class="col-span-9"><div class="card shadow-md card-body border border-base-300"><div class="justify-between flex"><div><h2 class="card-title mb-2">Project Members</h2><p class="text-sm font-medium mb-2">Before adding an member to your project, they must be <a class="text-primary underline" href="{{url_for("main.tenant_users")}}">invited to your tenant.</a></p></div><div><button @click="document.getElementById('memberModal').checked = true" class="btn btn-primary">Add Member</button></div></div><div class="grid grid-cols-6 gap-6"><div class="col-span-6"><div class="overflow-x-auto"><table class="table w-full"><thead><tr><th>#</th><th>Email</th><th>Access</th><th>Manage</th></tr></thead><tbody id="members-body"/></table></div></div></div></div></div>`)
      $(".input-members").empty().trigger('change');
      $(".input-members").select2();
      roles = ["manager","contributor","viewer","auditor"];
      for (var user in data) {
        var options = "";
        if (data[user].member) {
          for(var role in roles) {
            console.log(data[user].access_level)
            if (data[user].access_level === roles[role]) {
              options+=`<option selected="selected" value=${roles[role]}>${roles[role]}</option>`
            } else {
              options+=`<option value=${roles[role]}>${roles[role]}</option>`
            }
          }
          $("#members-body").append(`<tr><th>${data[user].id}</th><td class="text-sm font-medium">${data[user].email}</td><td><select @change="updateMemberAccess(${data[user].id})" id="member-${data[user].id}" class="select select-bordered select-sm w-full capitalize">${options}</select></td><td><button @click="removeMember(${data[user].id})" class="btn-xs btn btn-ghost border-base-300 border">Remove</button></td></tr>`)
        } else {
          var newOption = new Option(data[user].email, data[user].id, false, false);
          $('.input-members').append(newOption).trigger('change');
        }
      }
      return(data)
    },
    error: function(errMsg) {
        return(errMsg);
    }
  })
}
function updateMemberAccess(user_id) {
  $.ajax({
    type: "PUT",
    url: `/api/v1/projects/{{project.id}}/members/${user_id}/access`,
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    data: JSON.stringify({"access_level":$(`#member-${user_id}`).val()}),
    success: function(data){
      toast("Updated access level")
    },
    error: function(errMsg) {
        toast(errMsg["responseJSON"]["message"],"error")
        return(errMsg);
    }
  })
}
function removeMember(user_id) {
  $.ajax({
    type: "DELETE",
    url: `/api/v1/projects/{{project.id}}/members/${user_id}`,
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){
      toast("Removed user")
      loadSettings()
    },
    error: function(errMsg) {
        toast(errMsg["responseJSON"]["message"],"error")
        return(errMsg);
    }
  })
}
function addMembers() {
  disableButton('.add-project-member-btn');
  $.ajax({
    type: "POST",
    url: `/api/v1/projects/{{project.id}}/members`,
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    data: JSON.stringify({"members":$(".input-members").select2('data')}),
    success: function(data){
      document.getElementById('memberModal').checked = false;
      toast("Added members")
      loadSettings()
    },
    error: function(errMsg) {
        toast(errMsg["responseJSON"]["message"],"error")
        return(errMsg);
    },
    complete: function() {
      enableButton('.add-project-member-btn');
    },
  })
}
function loadMatrix() {
  //load matrix for the project
  $("#card-div").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
  $.ajax({
    type: "GET",
    url: "/api/v1/projects/{{project.id}}/matrix/summary",
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){
      var owners_total = 0;
      var operators_total = 0;
      var owners_table_body = "";
      var operators_table_body = "";
      for (var record in data.owners) {
        owners_total += data.owners[record].subcontrols;
        owners_table_body += `<tr>
          <th>${data.owners[record].user_id}</th>
          <td>${data.owners[record].email}</td>
          <td>${data.owners[record].subcontrols}</td>
          <td><a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls&grouping=subcontrols&filter=1&owner=${data.owners[record].email}" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></a></td>
        </tr>`
      }
      for (var record in data.operators) {
        operators_total += data.operators[record].subcontrols;
        operators_table_body += `<tr>
          <th>${data.operators[record].user_id}</th>
          <td>${data.operators[record].email}</td>
          <td>${data.operators[record].subcontrols}</td>
          <td><a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls&grouping=subcontrols&filter=1&operator=${data.operators[record].email}" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></a></td>
        </tr>`
      }
      if (data.total !== owners_total) {
        owners_table_body += `<tr class="text-red-500">
          <th>null</th>
          <td>Missing Owner</td>
          <td>${data.total-owners_total}</td>
          <td><a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls&grouping=subcontrols&filter=1&owner=Missing" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></a></td>
        </tr>`
      }
      if (data.total !== operators_total) {
        operators_table_body += `<tr class="text-red-500">
          <th>null</th>
          <td>Missing Operator</td>
          <td>${data.total-operators_total}</td>
          <td><a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}?tab=controls&grouping=subcontrols&filter=1&operator=Missing" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></a></td>
        </tr>`
      }
      $("#card-div").html("");
      $("#card-div").html(`<div class="col-span-9"><div class="card shadow-md card-body border border-base-300"><div class=""><h2 class="card-title mb-2">Responsibility Matrix (Owners)</h2><p class="text-sm">The table below shows who is responsible for the control, grouped by count</p></div>
    <div class="grid grid-cols-6 gap-6">
      <div class="col-span-6">
<div class="overflow-x-auto">
  <table class="table w-full text-sm font-medium">
    <!-- head -->
    <thead>
      <tr>
        <th></th>
        <th>Email</th>
        <th># of Controls</th>
        <th>Explore</th>
      </tr>
    </thead>
    <tbody>
    ${owners_table_body}
    </tbody>
  </table>
</div>

      </div>
    </div>
</div></div>
`);
      $("#card-div").append(`<div class="col-span-9"><div class="card shadow-md card-body border border-base-300"><div class=""><h2 class="card-title mb-2">Responsibility Matrix (Operators)</h2><p class="text-sm">The table below shows who is responsible for executing the control to standards, grouped by count</p></div>
    <div class="grid grid-cols-6 gap-6">
      <div class="col-span-6">
<div class="overflow-x-auto">
  <table class="table w-full text-sm font-medium">
    <!-- head -->
    <thead>
      <tr>
        <th></th>
        <th>Email</th>
        <th># of Controls</th>
        <th>Explore</th>
      </tr>
    </thead>
    <tbody>
    ${operators_table_body}
    </tbody>
  </table>
</div>

      </div>
    </div>
</div></div>
`);
      return(data)
    },
    error: function(errMsg) {
        return(errMsg);
    }
  })
}
function loadSettings() {
  {%if is_auditor and not project.can_auditor_read_comments%}
  toast("You lack permissions to view the settings.","warning")
  $("#card-div").html('<div class="col-span-9 mx-auto mt-10 flex flex-row">Insufficient Permissions<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.182 16.318A4.486 4.486 0 0012.016 15a4.486 4.486 0 00-3.198 1.318M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" /></svg></div>')
  return
  {%endif%}
  //load settings for the project
  $("#card-div").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
  $.ajax({
    type: "GET",
    url: "/api/v1/projects/{{project.id}}",
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){
      $("#card-div").html("");
      $("#card-div").html(`<div class="col-span-9"><div class="card shadow-md card-body border border-base-300"><div class=""><h2 class="card-title mb-4">Project Settings</h2></div>
    <div class="grid grid-cols-6 gap-6">
      <div class="col-span-6 sm:col-span-3">
        <label for="name" class="block text-sm font-medium ">Name</label>
        <input type="text" name="name" value="${data.name}" id="name" class="mt-1 block border input-md w-full rounded-md border-base-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
      </div>

      <div class="col-span-6 sm:col-span-3">
        <label for="description" class="block text-sm font-medium ">Description</label>
        <input type="text" name="description" value="${data.description}" id="description" class="mt-1 block border input-md w-full rounded-md border-base-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
      </div>
      <div class="col-span-1">
        <label for="name" class="block text-sm font-medium mb-1">Read ScratchPad (Auditor)</label>
        <input type="checkbox" id="can_auditor_read_scratchpad" class="toggle toggle-primary" ${data.can_auditor_read_scratchpad ? 'checked' : ''} />
      </div>
      <div class="col-span-1">
        <label for="name" class="block text-sm font-medium mb-1">Write ScratchPad (Auditor)</label>
        <input type="checkbox" id="can_auditor_write_scratchpad" class="toggle toggle-primary" ${data.can_auditor_write_scratchpad ? 'checked' : ''} />
      </div>
      <div class="col-span-1">
        <label for="name" class="block text-sm font-medium mb-1">Read Comments (Auditor)</label>
        <input type="checkbox" id="can_auditor_read_comments" class="toggle toggle-primary" ${data.can_auditor_read_comments ? 'checked' : ''} />
      </div>
      <div class="col-span-1">
        <label for="name" class="block text-sm font-medium mb-1">Write Comments (Auditor)</label>
        <input type="checkbox" id="can_auditor_write_comments" class="toggle toggle-primary" ${data.can_auditor_write_comments ? 'checked' : ''} />
      </div>
      <div class="col-span-6">
        <button class="btn btn-md btn-primary save-btn">Save</button>
      </div>
    </div>
</div></div>
`);
      loadMembers()
      return(data)
    },
    error: function(errMsg) {
        return(errMsg);
    }
  })
}

$(document).on('click', '.save-btn', function() {
  var data = {
    "name":$("#name").val(),
    "description":$("#description").val(),
    "can_auditor_read_scratchpad":$("#can_auditor_read_scratchpad").is(':checked'),
    "can_auditor_write_scratchpad":$("#can_auditor_write_scratchpad").is(':checked'),
    "can_auditor_read_comments":$("#can_auditor_read_comments").is(':checked'),
    "can_auditor_write_comments":$("#can_auditor_write_comments").is(':checked'),
  };
  disableButton('.save-btn');
  $.ajax({
    type: "POST",
    url: `/api/v1/projects/{{project.id}}/settings`,
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    data: JSON.stringify(data),
    success: function(data){
      toast("Saved settings")
    },
    error: function(errMsg) {
        toast(errMsg["responseJSON"]["message"],"error")
        return(errMsg);
    },
    complete: function() {
      enableButton('.save-btn');
    },
  })
});

$(document).on('click', '.save-owner-btn', function() {
  var id = $(this).data("id")
  var owner = $(".owner-id").val();
  var operator = $(".operator-id").val();
  data = {}
  if(owner === "empty") {
    owner = null;
  }
  if(operator === "empty") {
    operator = null;
  }
  data["owner-id"] = owner;
  data["operator-id"] = operator;
  $.ajax({
    type: "PUT",
    url: `/api/v1/project-controls/{{project.id}}/subcontrols/${id}`,
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    data: JSON.stringify(data),
    success: function(data){
      toast('Updated subcontrol. You may need to refresh the data.')
    },
    error: function(errMsg) {
      toast(errMsg["responseJSON"]["message"],"error")
    }
  })
  document.getElementById('ownerModal').checked = false;
});

$(document).on('click', '.populate-owner-modal', function() {
  populateOwnerModal($(this).data("id"),$(this).data('owner'),$(this).data('operator'))
});


$(document).on('click', '.control-modal-btn', function() {
  var id = $(this).data('id')
  $.ajax({
    type: "GET",
    url: `/api/v1/projects/{{project.id}}/controls/${id}`,
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){
      if (data.is_complete) {
        $("#complete-modal-icon").html('<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-success"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z" /></svg>');
      } else {
        $("#complete-modal-icon").html('<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>');
      }
      if (data.is_applicable) {
        $("#applicable-modal-icon").html('<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-success"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z" /></svg>');
      } else {
        $("#applicable-control").html('<p class="bg-error text-error-content rounded-md p-4">Control has been marked as not applicable and will not be included in the project. If you wish to change this, please view and edit the control.</p>')
        $("#applicable-modal-icon").html('<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>');
      }

      $("#control-modal-completion").html(`<div id="modal-completion-${id}"></div>`)
      $("#control-modal-details").html("")
      $("#control-modal-title").html(`${data.id} - ${data.name}`);
      $("#control-modal-date").html(data.date_added);
      var options = {
            series: [100-data.progress_implemented,data.progress_implemented],
            legend: {
              show: false
            },
            dataLabels: {
              enabled: false
            },
            chart: {
              type: 'donut',
            },
plotOptions: {
    pie: {
      donut: {
        labels: {
          show: true,
        value:{
          offsetY: -8,
          color:'#6b6a6e'
        },
          total: {
            show: true,
            label: '',
            formatter: () => `${data.progress_implemented}%`
          }
        }
      }
    }
  },
            labels: ['Uncomplete', 'Complete'],
            fill:{colors:['#f3f4f6', '#4ade80']},
            responsive: [{
              breakpoint: 300,
              options: {
                chart: {
                  width: 100
                }
              }
            }]
      };
      new ApexCharts(document.querySelector(`#modal-completion-${id}`), options).render()
      $("#control-modal-details").append(`<div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"><dt class="text-sm font-medium">Name</dt><dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">${data.name}</dd></div>`)
      $("#control-modal-details").append(`<div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"><dt class="text-sm font-medium">Status</dt><dd class="mt-1 text-sm sm:col-span-2 sm:mt-0 capitalize text-primary bg-base-200 rounded-md py-1 px-2 font-semibold w-fit">${data.status}</dd></div>`)
      $("#control-modal-details").append(`<div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"><dt class="text-sm font-medium">Description</dt><dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">${data.description}</dd></div>`)
      $("#control-modal-details").append(`<div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"><dt class="text-sm font-medium">Subcontrols</dt><dd class="mt-1 text-sm sm:col-span-2 sm:mt-0">${data.subcontrol_count}</dd></div>`)
      $("#control-modal-details").append(`<div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"><dt class="text-sm font-medium">Category</dt><dd class="mt-1 text-sm sm:col-span-2 sm:mt-0 capitalize">${data.category}</dd></div>`)
      $("#control-modal-details").append(`<div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"><dt class="text-sm font-medium">Subcategory</dt><dd class="mt-1 text-sm sm:col-span-2 sm:mt-0 capitalize">${data.subcategory}</dd></div>`)
      $("#control-modal-details").append(`<div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"><dt class="text-sm font-medium">Reference Code</dt><dd class="mt-1 text-sm sm:col-span-2 sm:mt-0 uppercase text-primary bg-base-200 rounded-md py-1 px-2 font-semibold w-fit">${data.ref_code}</dd></div>`)
    },
    error: function(errMsg) {
        return(errMsg);
    }
  })
  document.getElementById('control-modal').checked = true;
  $("#view-control").attr("href",`/projects/{{project.id}}/controls/${id}`)
});

// on load of page
function loadPageElements(tab) {
  if(document.getElementById("save-notes-btn")) {
    saveScratchPad(showToast=false)
  }

  $(".tabs span").removeClass("bg-base-200");
  $(`#tab-${tab}`).addClass("bg-base-200")
  if (tab == null) {
    var tab = "summary"
  }
  if (tab === "controls") {
    loadControls(reload=true)
  } else if (tab === "summary") {
    loadSummary()
  } else if (tab === "policies") {
    loadPolicies()
  } else if (tab === "evidence") {
    loadEvidence()
  } else if (tab === "matrix") {
    loadMatrix()
  } else if (tab === "scratchpad") {
    loadScratchPad()
  } else if (tab === "comments") {
    loadComments()
  } else if (tab === "report") {
    loadReport()
  } else if (tab === "settings") {
    loadSettings()
  } else {
    loadSummary();
  }
  $(".select").val(tab)
  var queryParams = new URLSearchParams(window.location.search);
  queryParams.set("tab", tab);
  history.replaceState(null, null, "?"+queryParams.toString());
};
var params = new window.URLSearchParams(window.location.search);
var tab = params.get('tab');
loadUsers(reload=true);
loadPageElements(tab);
loadQuickFilters();
</script>
{%endblock%}
